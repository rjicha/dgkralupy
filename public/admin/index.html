<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Administrace - DG Kralupy</title>

  <!-- Custom styles -->
  <style>
    /* Brand colors and custom styling */
    :root {
      --primary: #3b5f78;
      --primary-dark: #273946;
      --secondary: #44c2c4;
    }

    /* Custom admin interface styling */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
    }

    /* Loading overlay - hidden once CMS loads */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
      font-size: 18px;
      color: var(--primary);
      z-index: 9999;
    }

    #loading-overlay.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Loading overlay - hidden once CMS mounts -->
  <div id="loading-overlay">
    Naƒç√≠t√°n√≠ administrace...
  </div>

  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <!-- Inline Custom Widgets Registration -->
  <script>
    /* eslint-disable no-undef, @typescript-eslint/no-this-alias */
    /* global CMS, h, createClass */
    (function() {
      'use strict';

      console.log('='.repeat(60));
      console.log('üöÄ WIDGET REGISTRATION SCRIPT STARTED');
      console.log('='.repeat(60));

      // Check if required globals are available
      console.log('Checking required globals...');
      console.log('- window.CMS:', typeof window.CMS, window.CMS);
      console.log('- createClass:', typeof createClass);
      console.log('- h:', typeof h);

      if (!window.CMS) {
        console.error('‚ùå CRITICAL: CMS object not found! Decap CMS may not be loaded yet.');
        return;
      }

      if (typeof createClass === 'undefined') {
        console.error('‚ùå CRITICAL: createClass function not found!');
        return;
      }

      if (typeof h === 'undefined') {
        console.error('‚ùå CRITICAL: h function not found!');
        return;
      }

      console.log('‚úÖ All required globals are available');

        // ==========================================
        // AUTHOR WIDGET (localStorage-based)
        // ==========================================
        // Uses undocumented localStorage access to read current user
        // Decap CMS stores user data in: window.localStorage.getItem('decap-cms-user')
        console.log('üìù Defining Author widget...');

        var AuthorControl = createClass({
          getInitialState: function() {
            return {
              author: this.props.value || 'Redakce',
              isAutoPopulated: false
            };
          },

          componentDidMount: function() {
            var self = this;

            // Don't override if user already set a value
            if (this.props.value) {
              console.log('[Author Widget] Using existing value:', this.props.value);
              return;
            }

            try {
              // Read user from localStorage (where Decap CMS stores it)
              var storedUser = window.localStorage.getItem('decap-cms-user');

              if (!storedUser) {
                console.log('[Author Widget] No stored user found, using default');
                this.setState({ author: 'Redakce' });
                this.props.onChange('Redakce');
                return;
              }

              var userData = JSON.parse(storedUser);
              console.log('[Author Widget] Found stored user:', userData);

              // Extract username (GitHub: login, GitLab/Bitbucket: username)
              var username = userData.login || userData.username || userData.name;

              if (!username) {
                console.log('[Author Widget] No username in stored data, using default');
                this.setState({ author: 'Redakce' });
                this.props.onChange('Redakce');
                return;
              }

              console.log('[Author Widget] GitHub username:', username);

              // Determine base path - handle both dev and production
              var basePath = '';
              var pathParts = window.location.pathname.split('/').filter(function(p) { return p; });

              // In dev: /dgkralupy/admin/index.html -> base is /dgkralupy
              // In prod: /dgkralupy/admin/ -> base is /dgkralupy
              if (pathParts.length > 0 && pathParts[0] !== 'admin') {
                basePath = '/' + pathParts[0];
              }

              // The file is in the public folder at build time, served at root
              var authorsPath = basePath + '/authors.json';
              console.log('[Author Widget] Loading authors from:', authorsPath);

              // Fetch and map username to display name
              fetch(authorsPath)
                .then(function(response) {
                  if (!response.ok) {
                    throw new Error('authors.json not found');
                  }
                  return response.json();
                })
                .then(function(data) {
                  var mapping = data.mappings.find(function(m) {
                    return m.github === username || m.username === username;
                  });
                  var authorName = mapping ? mapping.displayName : (data.defaultAuthor || 'Redakce');

                  console.log('[Author Widget] Mapped:', username, '‚Üí', authorName);
                  self.setState({
                    author: authorName,
                    isAutoPopulated: true
                  });
                  self.props.onChange(authorName);
                })
                .catch(function(error) {
                  console.log('[Author Widget] Error loading authors.json:', error.message);
                  // Fallback: use GitHub username as-is
                  self.setState({
                    author: username,
                    isAutoPopulated: true
                  });
                  self.props.onChange(username);
                });

            } catch (error) {
              console.log('[Author Widget] Error:', error.message, '- using default');
              this.setState({ author: 'Redakce' });
              this.props.onChange('Redakce');
            }
          },

          render: function() {
            return h('div', {
              className: this.props.classNameWrapper,
              style: { padding: '10px', borderRadius: '4px', border: '1px solid #ddd', backgroundColor: '#fafafa' }
            },
              h('label', {
                htmlFor: this.props.forID,
                style: { display: 'block', marginBottom: '5px', fontWeight: 'bold', fontSize: '14px' }
              }, 'Autor'),

              h('input', {
                type: 'text',
                id: this.props.forID,
                value: this.state.author,
                readOnly: true,
                style: {
                  width: '100%',
                  padding: '8px',
                  backgroundColor: '#f5f5f5',
                  border: '1px solid #ccc',
                  borderRadius: '3px',
                  fontSize: '14px'
                }
              }),

              h('p', {
                style: {
                  marginTop: '8px',
                  marginBottom: '0',
                  fontSize: '12px',
                  color: '#888'
                }
              }, this.state.isAutoPopulated
                  ? 'Autor nastaven automaticky z GitHub √∫ƒçtu'
                  : 'Autor je nastaven automaticky p≈ôi vytvo≈ôen√≠ ƒçl√°nku')
            );
          }
        });

        console.log('‚úÖ Author control component defined');

        var AuthorPreview = createClass({
          render: function() {
            return h('div', {},
              h('strong', {}, 'Autor: '),
              this.props.value || 'Redakce'
            );
          }
        });
        console.log('‚úÖ Author preview component defined');

        // ==========================================
        // ENHANCED IMAGE WIDGET
        // ==========================================
        console.log('üñºÔ∏è  Defining Enhanced Image widget...');
        var MAX_ALT_LENGTH = 125;
        var MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB
        var ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];

        var EnhancedImageControl = createClass({
          getInitialState: function() {
            console.log('='.repeat(60));
            console.log('[Enhanced Image] getInitialState called');
            console.log('[Enhanced Image] this.props.value:', this.props.value);
            console.log('[Enhanced Image] this.props.onChange:', typeof this.props.onChange);
            console.log('='.repeat(60));

            var value = this.props.value;

            // Base state shared by all branches
            var state = {
              error: null,
              isDragging: false,
              previewUrl: null,
              src: null,
              alt: '',
              focusPoint: { x: 50, y: 50 },
              crops: {}
            };

            // Handle different value types
            if (!value) {
              // No value - return empty state (already set above)
              console.log('[Enhanced Image] No initial value');
              return state;
            }

            if (typeof value === 'string') {
              // Cloudinary URL string
              console.log('[Enhanced Image] Initializing with Cloudinary URL:', value);
              state.src = value;
              return state;
            }

            if (typeof value === 'object') {
              // Enhanced object format
              console.log('[Enhanced Image] Initializing with object format:', value);
              state.src = value.src || value.url || null;
              state.alt = value.alt || '';
              state.focusPoint = value.focusPoint || { x: 50, y: 50 };
              state.crops = value.crops || {};
              return state;
            }

            // Fallback for unexpected types
            console.warn('[Enhanced Image] Unexpected value type:', typeof value, value);
            return state;
          },

          componentDidUpdate: function(prevProps) {
            console.log('[Enhanced Image] componentDidUpdate called');
            console.log('[Enhanced Image] prevProps.value:', prevProps.value);
            console.log('[Enhanced Image] this.props.value:', this.props.value);
            console.log('[Enhanced Image] Current state:', this.state);

            // Only update if value actually changed
            if (prevProps.value !== this.props.value && this.props.value) {
              var value = this.props.value;
              console.log('[Enhanced Image] Value changed! New value:', value);
              console.log('[Enhanced Image] Value type:', typeof value);

              // Handle both string URLs (from Cloudinary) and object format
              var newState;
              if (typeof value === 'string') {
                // Cloudinary returns a URL string
                console.log('[Enhanced Image] Received URL string from Cloudinary:', value);
                newState = {
                  src: value,
                  alt: this.state.alt || '',  // Preserve existing alt or empty
                  focusPoint: this.state.focusPoint || { x: 50, y: 50 },
                  crops: this.state.crops || {},
                  previewUrl: null,  // Clear any blob URL
                  error: null  // Clear any errors
                };
              } else if (typeof value === 'object' && value !== null) {
                // Object format (our enhanced format)
                console.log('[Enhanced Image] Received object format:', value);
                newState = {
                  src: value.src || value.url || null,
                  alt: value.alt || '',
                  focusPoint: value.focusPoint || { x: 50, y: 50 },
                  crops: value.crops || {},
                  previewUrl: null,
                  error: null
                };
              } else {
                // Invalid or null value
                console.log('[Enhanced Image] Invalid value type, ignoring');
                return;
              }

              console.log('[Enhanced Image] Setting new state:', newState);
              // CRITICAL: Just update state, DO NOT call emitChange()
              // The value is already set by CMS via props.value
              // Calling emitChange() here would cause infinite loop:
              //   componentDidUpdate -> setState -> emitChange -> props.onChange ->
              //   parent updates -> componentDidUpdate (again) -> infinite loop
              this.setState(newState, function() {
                console.log('[Enhanced Image] State updated successfully:', this.state);
              });
            }
          },

          validateFile: function(file) {
            if (!ALLOWED_TYPES.includes(file.type)) {
              return 'Podporovan√© form√°ty: JPG, PNG, WebP';
            }
            if (file.size > MAX_FILE_SIZE) {
              return 'Maxim√°ln√≠ velikost souboru je 5 MB';
            }
            return null;
          },

          handleFileSelect: function(e) {
            var self = this;
            var file = e.target.files[0];
            if (!file) return;

            console.log('File selected:', file.name, file.type, file.size);
            console.log('Available props:', Object.keys(this.props));

            var validationError = this.validateFile(file);
            if (validationError) {
              console.error('Validation error:', validationError);
              this.setState({ error: validationError });
              return;
            }

            // Add the asset to Decap CMS's media store
            if (this.props.onAddAsset) {
              console.log('Using onAddAsset to upload file...');
              try {
                // onAddAsset returns a Redux action {type: 'ADD_ASSET', payload: File}
                var action = this.props.onAddAsset(file);
                console.log('onAddAsset returned:', action);

                // Extract the file from the action payload
                var uploadedFile = action.payload;

                // Construct the image path based on public_folder setting
                // Files go to media_folder (public/images) and are served from public_folder (/images)
                var imagePath = '/images/' + uploadedFile.name;

                // Create a blob URL for preview (since file isn't on server yet)
                var blobUrl = URL.createObjectURL(uploadedFile);

                console.log('Constructed image path:', imagePath);
                console.log('Created blob URL for preview:', blobUrl);

                // Store the final path for saving, but use blob URL for preview
                self.setState({
                  src: imagePath,  // This will be saved in frontmatter
                  previewUrl: blobUrl,  // This will be used for display
                  error: null
                }, function() {
                  console.log('State updated successfully');
                  self.emitChange();
                });
              } catch (error) {
                console.error('Error in onAddAsset:', error);
                self.setState({ error: 'Chyba p≈ôi nahr√°v√°n√≠: ' + error.message });
              }
            } else {
              console.error('onAddAsset not available in props');
              self.setState({ error: 'Nahr√°v√°n√≠ soubor≈Ø nen√≠ dostupn√©' });
            }
          },

          handleAltChange: function(e) {
            var alt = e.target.value.slice(0, MAX_ALT_LENGTH);
            var self = this;
            this.setState({ alt: alt }, function() {
              self.emitChange();
            });
          },

          handleFocusPointChange: function(e) {
            var rect = e.currentTarget.getBoundingClientRect();
            var x = Math.round(((e.clientX - rect.left) / rect.width) * 100);
            var y = Math.round(((e.clientY - rect.top) / rect.height) * 100);
            var self = this;

            this.setState({
              focusPoint: {
                x: Math.max(0, Math.min(100, x)),
                y: Math.max(0, Math.min(100, y))
              }
            }, function() {
              self.emitChange();
            });
          },

          handleRemove: function() {
            this.setState({
              src: null,
              alt: '',
              focusPoint: { x: 50, y: 50 },
              crops: {}
            });
            this.props.onChange(null);
          },

          emitChange: function() {
            var src = this.state.src;
            var alt = this.state.alt;
            var focusPoint = this.state.focusPoint;
            var crops = this.state.crops;

            console.log('[Enhanced Image] emitChange called');
            console.log('[Enhanced Image] Current state:', { src, alt, focusPoint, crops });

            if (!src) {
              console.log('[Enhanced Image] No src, calling onChange(null)');
              this.props.onChange(null);
              return;
            }

            var value = {
              src: src,
              alt: alt,
              focusPoint: focusPoint,
              crops: crops
            };
            console.log('[Enhanced Image] Calling onChange with:', value);
            this.props.onChange(value);
          },

          handleDropzoneClick: function() {
            var self = this;
            console.log('='.repeat(60));
            console.log('[Enhanced Image] handleDropzoneClick - Opening media library');
            console.log('[Enhanced Image] Current state:', this.state);
            console.log('[Enhanced Image] Available props:', Object.keys(this.props));
            console.log('='.repeat(60));

            // Open media library dialog - this handles the upload properly
            if (this.props.onOpenMediaLibrary) {
              try {
                console.log('[Enhanced Image] Calling onOpenMediaLibrary...');
                this.props.onOpenMediaLibrary({
                  controlMedia: this.props.mediaPaths,
                  forImage: true,
                  value: this.state.src,
                  // Callback when media is selected
                  allowMultiple: false,
                  config: this.props.field.get('config'),
                  field: this.props.field
                });
                console.log('[Enhanced Image] onOpenMediaLibrary called successfully');
              } catch (error) {
                console.error('[Enhanced Image] Error opening media library:', error);
                // Fallback to file input on error
                if (this.fileInputRef) {
                  this.fileInputRef.click();
                }
              }
            } else if (this.fileInputRef) {
              console.log('[Enhanced Image] onOpenMediaLibrary not available, using file input');
              // Fallback to file input if media library not available
              this.fileInputRef.click();
            }
          },

          render: function() {
            var self = this;
            var src = this.state.src;
            var alt = this.state.alt;
            var focusPoint = this.state.focusPoint;
            var error = this.state.error;
            var isDragging = this.state.isDragging;
            var previewUrl = this.state.previewUrl;

            // Use preview URL for display if available (for newly uploaded files),
            // otherwise use the src path (for saved files)
            var displaySrc = previewUrl || src;

            console.log('[Enhanced Image] Rendering with state:', {
              src: src,
              alt: alt,
              focusPoint: focusPoint,
              previewUrl: previewUrl,
              displaySrc: displaySrc,
              error: error
            });

            var containerStyle = {
              border: '1px solid #ddd',
              borderRadius: '4px',
              padding: '16px',
              marginBottom: '16px'
            };

            var dropzoneStyle = {
              border: '2px dashed ' + (isDragging ? '#3b5f78' : '#ccc'),
              borderRadius: '8px',
              padding: '40px',
              textAlign: 'center',
              cursor: 'pointer',
              backgroundColor: isDragging ? '#f0f7ff' : 'transparent',
              transition: 'all 0.2s'
            };

            var errorStyle = {
              padding: '12px',
              backgroundColor: '#fee',
              border: '1px solid #fcc',
              borderRadius: '4px',
              color: '#c00',
              marginBottom: '12px'
            };

            return h('div', { className: 'enhanced-image-widget', style: containerStyle },
              error && h('div', { style: errorStyle }, error),
              
              !src && h('div', {
                style: dropzoneStyle,
                onClick: this.handleDropzoneClick
              },
                h('p', {}, 'üìÅ Kliknƒõte nebo p≈ôet√°hnƒõte obr√°zek'),
                h('p', { style: { fontSize: '12px', color: '#666', marginTop: '4px' } }, 
                  'JPG, PNG, WebP ‚Ä¢ Max 5 MB'),
                h('input', {
                  ref: function(ref) { self.fileInputRef = ref; },
                  type: 'file',
                  accept: 'image/jpeg,image/png,image/webp',
                  style: { display: 'none' },
                  onChange: this.handleFileSelect
                })
              ),
              
              src && h('div', { style: { marginTop: '16px' } },
                h('div', {
                  style: {
                    position: 'relative',
                    cursor: 'crosshair',
                    marginBottom: '16px'
                  },
                  onClick: this.handleFocusPointChange
                },
                  h('img', {
                    src: displaySrc,
                    alt: alt,
                    style: {
                      maxWidth: '100%',
                      display: 'block',
                      borderRadius: '4px'
                    },
                    onError: function(e) {
                      console.error('[Enhanced Image] Failed to load image:', displaySrc);
                      e.target.style.display = 'none';
                      // Optionally show error message
                    },
                    onLoad: function() {
                      console.log('[Enhanced Image] Image loaded successfully:', displaySrc);
                    }
                  }),
                  h('div', {
                    style: {
                      position: 'absolute',
                      width: '20px',
                      height: '20px',
                      marginLeft: '-10px',
                      marginTop: '-10px',
                      borderRadius: '50%',
                      border: '3px solid #ff6b6b',
                      backgroundColor: 'rgba(255, 107, 107, 0.3)',
                      pointerEvents: 'none',
                      left: focusPoint.x + '%',
                      top: focusPoint.y + '%'
                    }
                  })
                ),
                
                h('div', { style: { marginBottom: '12px' } },
                  h('label', {
                    style: {
                      display: 'block',
                      marginBottom: '4px',
                      fontWeight: 500,
                      fontSize: '14px'
                    }
                  }, 'Alternativn√≠ text (povinn√Ω)'),
                  h('input', {
                    type: 'text',
                    value: alt,
                    maxLength: MAX_ALT_LENGTH,
                    placeholder: 'Popis obr√°zku pro nevidom√© u≈æivatele',
                    style: {
                      width: '100%',
                      padding: '8px',
                      border: '1px solid #ddd',
                      borderRadius: '4px',
                      fontSize: '14px'
                    },
                    onChange: this.handleAltChange
                  }),
                  h('span', {
                    style: {
                      fontSize: '12px',
                      color: '#666',
                      marginTop: '4px',
                      display: 'block'
                    }
                  }, alt.length + '/' + MAX_ALT_LENGTH + ' znak≈Ø')
                ),
                
                h('div', {
                  style: {
                    padding: '8px',
                    backgroundColor: '#f5f5f5',
                    borderRadius: '4px',
                    fontSize: '13px',
                    marginBottom: '12px'
                  }
                },
                  h('strong', {}, 'Ohnisko: '),
                  focusPoint.x + '%, ' + focusPoint.y + '% ‚Ä¢ Kliknƒõte na obr√°zek pro zmƒõnu'
                ),
                
                h('button', {
                  type: 'button',
                  style: {
                    padding: '8px 16px',
                    backgroundColor: '#f44',
                    color: 'white',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: 'pointer'
                  },
                  onClick: this.handleRemove
                }, 'üóëÔ∏è Odstranit obr√°zek')
              )
            );
          }
        });
        console.log('‚úÖ Enhanced Image control component defined');

        var EnhancedImagePreview = createClass({
          render: function() {
            var value = this.props.value || {};

            if (!value.src) {
              return h('div', {}, '≈Ω√°dn√Ω obr√°zek');
            }

            return h('div', {},
              h('img', {
                src: value.src,
                alt: value.alt,
                style: {
                  maxWidth: '300px',
                  display: 'block',
                  marginBottom: '8px'
                }
              }),
              value.alt && h('p', {}, value.alt)
            );
          }
        });
        console.log('‚úÖ Enhanced Image preview component defined');

      // ==========================================
      // REGISTER WIDGETS
      // ==========================================
      console.log('');
      console.log('üìã Starting widget registration...');
      console.log('- CMS.registerWidget type:', typeof CMS.registerWidget);

      try {
        console.log('Registering author widget...');
        console.log('- Control:', typeof AuthorControl);
        console.log('- Preview:', typeof AuthorPreview);
        CMS.registerWidget('author', AuthorControl, AuthorPreview);
        console.log('‚úÖ Author widget registered successfully');

        console.log('Registering enhanced-image widget...');
        console.log('- Control:', typeof EnhancedImageControl);
        console.log('- Preview:', typeof EnhancedImagePreview);
        CMS.registerWidget('enhanced-image', EnhancedImageControl, EnhancedImagePreview);
        console.log('‚úÖ Enhanced-image widget registered successfully');

        console.log('');
        console.log('='.repeat(60));
        console.log('üéâ ALL CUSTOM WIDGETS REGISTERED SUCCESSFULLY');
        console.log('='.repeat(60));
      } catch (error) {
        console.error('');
        console.error('='.repeat(60));
        console.error('‚ùå WIDGET REGISTRATION FAILED');
        console.error('='.repeat(60));
        console.error('Error:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        
        // Display error to user
        var errorDiv = document.createElement('div');
        errorDiv.style.cssText = '\
          position: fixed;\
          top: 20px;\
          left: 50%;\
          transform: translateX(-50%);\
          background: #fee;\
          border: 2px solid #c00;\
          color: #c00;\
          padding: 16px 24px;\
          border-radius: 8px;\
          z-index: 10000;\
          font-family: sans-serif;\
          max-width: 500px;\
          text-align: center;\
        ';
        errorDiv.textContent = 'Chyba p≈ôi registraci widget≈Ø: ' + error.message;
        document.body.appendChild(errorDiv);
      }

      // ==========================================
      // VERIFY REGISTRATION
      // ==========================================
      console.log('');
      console.log('üîç Verifying widget registration...');
      if (window.CMS && window.CMS.getWidget) {
        try {
          var authorWidget = CMS.getWidget('author');
          var imageWidget = CMS.getWidget('enhanced-image');
          console.log('- author widget:', authorWidget ? '‚úÖ Found' : '‚ùå Not found');
          console.log('- enhanced-image widget:', imageWidget ? '‚úÖ Found' : '‚ùå Not found');
        } catch (e) {
          console.log('‚ö†Ô∏è Could not verify widgets using CMS.getWidget():', e.message);
        }
      } else {
        console.log('‚ö†Ô∏è CMS.getWidget() not available');
      }

      // ==========================================
      // HIDE LOADING OVERLAY WHEN CMS READY
      // ==========================================
      CMS.registerEventListener({
        name: 'postPublish',
        handler: function() {
          var loadingOverlay = document.getElementById('loading-overlay');
          if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
          }
        }
      });

      // Hide loading overlay after a short delay to ensure CMS has mounted
      setTimeout(function() {
        var loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.classList.add('hidden');
        }
      }, 1000);

    })();
  </script>
</body>
</html>