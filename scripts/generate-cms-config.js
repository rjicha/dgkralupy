#!/usr/bin/env node

/**
 * Generate Decap CMS config.yml with environment-specific settings
 *
 * This script generates the CMS configuration with the correct:
 * - site_url (staging vs production)
 * - public_folder (images path with or without base URL)
 *
 * Called as a prebuild step in package.json
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Determine environment from SITE_URL or default to staging
const siteUrl = process.env.SITE_URL || 'https://rjicha.github.io/dgkralupy';
const isProduction = siteUrl === 'https://dgkralupy.cz';

// Set appropriate values
const displayUrl = siteUrl;
const publicFolder = isProduction ? '/images' : '/dgkralupy/images';

console.log('üîß Generating Decap CMS configuration...');
console.log(`   Environment: ${isProduction ? 'Production' : 'Staging'}`);
console.log(`   Site URL: ${siteUrl}`);
console.log(`   Public folder: ${publicFolder}`);

const config = `# Decap CMS Configuration for Dvo≈ô√°kovo gymn√°zium
# Auto-generated by scripts/generate-cms-config.js
# DO NOT EDIT MANUALLY - Changes will be overwritten on next build

backend:
  name: github
  repo: rjicha/dgkralupy
  branch: main
  # IMPORTANT: Replace with your OAuth provider URL after deployment
  # Deploy https://github.com/vencax/netlify-cms-github-oauth-provider to Vercel/Netlify
  # Then update this URL:
  base_url: https://dgkralupy-oauth.vercel.app/
  auth_endpoint: auth

# Site configuration
site_url: ${siteUrl}
display_url: ${displayUrl}

# Media files configuration
media_folder: "public/images"
public_folder: "${publicFolder}"

# Locale
locale: 'cs'

# Collections
collections:
  # Articles Collection
  - name: "articles"
    label: "ƒål√°nky a aktuality"
    label_singular: "ƒål√°nek"
    folder: "src/content/articles"
    create: true
    slug: "{{slug}}"
    extension: "md"
    format: "frontmatter"
    fields:
      - { label: "Nadpis", name: "title", widget: "string", required: true, hint: "Hlavn√≠ nadpis ƒçl√°nku" }
      - { label: "Perex", name: "excerpt", widget: "text", required: true, hint: "Kr√°tk√Ω √∫vodn√≠ text (2-3 vƒõty)" }
      - { label: "Obsah ƒçl√°nku", name: "body", widget: "markdown", required: true }
      - { label: "Datum publikace", name: "publishedAt", widget: "datetime", format: "DD.MM.YYYY", date_format: "DD.MM.YYYY", time_format: false, required: true }
      - { label: "Autor", name: "author", widget: "string", required: true, default: "Redakce" }
      - { label: "≈†t√≠tky", name: "tags", widget: "list", required: false, hint: "Nap≈ô: Akce, Sport, Studium", default: [] }
      - { label: "Obr√°zek", name: "image", widget: "image", required: false, hint: "Hlavn√≠ obr√°zek ƒçl√°nku" }
      - { label: "Zv√Ωraznƒõn√Ω ƒçl√°nek", name: "featured", widget: "boolean", default: false, required: false, hint: "Zobrazit na hlavn√≠ str√°nce" }
      - { label: "D≈Øle≈æit√© ozn√°men√≠", name: "important", widget: "boolean", default: false, required: false, hint: "Oznaƒçit jako d≈Øle≈æit√©" }
      - { label: "Koncept", name: "draft", widget: "boolean", default: false, required: false, hint: "Nezobrazovat na webu" }

  # Pages Collection
  - name: "pages"
    label: "Str√°nky"
    label_singular: "Str√°nka"
    folder: "src/content/pages"
    create: true
    slug: "{{slug}}"
    extension: "md"
    format: "frontmatter"
    fields:
      - { label: "Nadpis str√°nky", name: "title", widget: "string", required: true }
      - { label: "Popis (SEO)", name: "description", widget: "text", required: false, hint: "Popis pro vyhled√°vaƒçe" }
      - { label: "Obsah", name: "body", widget: "markdown", required: true }
      - { label: "Nad≈ôazen√° sekce", name: "section", widget: "select", options: ["O ≈°kole", "Studium", "Aktivity", "Kontakty", "Pomoc jin√Ωm", "Ostatn√≠"], required: false }
      - { label: "Po≈ôad√≠ v menu", name: "order", widget: "number", default: 0, value_type: "int", required: false, hint: "ƒå√≠m ni≈æ≈°√≠ ƒç√≠slo, t√≠m v√Ω≈°e v menu" }
      - { label: "Skr√Ωt z menu", name: "hideFromNav", widget: "boolean", default: false, required: false }
      - { label: "Koncept", name: "draft", widget: "boolean", default: false, required: false }

  # Settings - File-based collections
  - name: "settings"
    label: "Nastaven√≠ webu"
    files:
      # Contacts settings
      - label: "Kontakty ≈°koly"
        name: "contacts"
        file: "src/content/contacts/contacts.json"
        fields:
          - label: "≈†kola"
            name: "school"
            widget: "object"
            fields:
              - { label: "N√°zev", name: "name", widget: "string", required: true }
              - { label: "Adresa", name: "address", widget: "string", required: true }
              - { label: "Mƒõsto", name: "city", widget: "string", required: true }
              - { label: "Telefon", name: "phone", widget: "string", required: true }
              - { label: "Email", name: "email", widget: "string", required: true }
              - { label: "IƒåO", name: "ico", widget: "string", required: true }
              - { label: "DIƒå", name: "dic", widget: "string", required: true }
              - { label: "ƒå√≠slo √∫ƒçtu", name: "bankAccount", widget: "string", required: true }
          - label: "J√≠delna"
            name: "cafeteria"
            widget: "object"
            fields:
              - { label: "Telefon", name: "phone", widget: "string", required: true }
              - { label: "Email", name: "email", widget: "string", required: true }
              - { label: "ID podatelny", name: "submission", widget: "string", required: true }
          - label: "Soci√°ln√≠ s√≠tƒõ"
            name: "socialMedia"
            widget: "object"
            fields:
              - { label: "Facebook URL", name: "facebook", widget: "string", required: false }
              - { label: "Instagram URL", name: "instagram", widget: "string", required: false }

      # Navigation settings
      - label: "Navigace"
        name: "navigation"
        file: "src/content/navigation/navigation.json"
        fields:
          - label: "Hlavn√≠ menu"
            name: "sections"
            widget: "list"
            fields:
              - { label: "ID", name: "id", widget: "string", required: true }
              - { label: "N√°zev sekce", name: "title", widget: "string", required: true }
              - { label: "URL", name: "url", widget: "string", required: true }
              - { label: "Barva", name: "color", widget: "select", options: ["primary", "primary-dark", "secondary", "accent-green", "accent-coral", "accent-rose"], required: true }
              - label: "Podsekce"
                name: "subsections"
                widget: "list"
                required: false
                fields:
                  - { label: "N√°zev", name: "title", widget: "string", required: true }
                  - { label: "URL", name: "url", widget: "string", required: true }

      # Quick links settings
      - label: "Rychl√© odkazy"
        name: "quick-links"
        file: "src/content/quick-links/quick-links.json"
        fields:
          - label: "Odkazy"
            name: "links"
            widget: "list"
            fields:
              - { label: "N√°zev", name: "title", widget: "string", required: true }
              - { label: "URL", name: "url", widget: "string", required: true }
              - { label: "Barva", name: "color", widget: "select", options: ["primary", "secondary", "accent-green", "accent-coral", "accent-rose"], required: true }
`;

const configPath = path.join(__dirname, '../public/admin/config.yml');
fs.writeFileSync(configPath, config, 'utf-8');

console.log('‚úÖ CMS configuration generated successfully');
console.log(`   Output: public/admin/config.yml\n`);
