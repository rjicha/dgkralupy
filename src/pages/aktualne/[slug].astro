---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

// Get the slug from the URL
export async function getStaticPaths() {
  const articles = await getCollection('articles');

  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

interface Props {
  article: CollectionEntry<'articles'>;
}

const { article } = Astro.props;
const { Content } = await article.render();

// Get related articles (same tags, excluding current article)
const allArticles = await getCollection('articles', ({ data }) => data.draft !== true);
const relatedArticles = allArticles
  .filter((a) => a.slug !== article.slug && a.data.tags.some((tag) => article.data.tags.includes(tag)))
  .slice(0, 3);
---

<BaseLayout
  title={`${article.data.title} | Dvo≈ô√°kovo gymn√°zium`}
  description={article.data.excerpt}
>
  <article class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    <nav class="mb-6 text-sm">
      <ol class="flex items-center gap-2 text-text-muted">
        <li><a href={import.meta.env.BASE_URL + "/"} class="hover:text-accent-rose transition-colors">Dom≈Ø</a></li>
        <li>/</li>
        <li><a href={import.meta.env.BASE_URL + "/aktualne"} class="hover:text-accent-rose transition-colors">Aktuality</a></li>
        <li>/</li>
        <li class="text-text-primary truncate max-w-xs">{article.data.title}</li>
      </ol>
    </nav>

    <!-- Article Header -->
    <header class="mb-8">
      {article.data.important && (
        <div class="mb-4">
          <span class="bg-accent-coral text-white px-4 py-2 text-sm font-normal uppercase inline-block">
            D≈Øle≈æit√© ozn√°men√≠
          </span>
        </div>
      )}

      <h1 class="text-4xl md:text-5xl font-heading font-thin uppercase text-text-primary mb-6 leading-tight">
        {article.data.title}
      </h1>

      <!-- Metadata -->
      <div class="flex flex-wrap items-center gap-4 text-text-muted mb-4">
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <time datetime={article.data.publishedAt} class="text-sm uppercase">
            {article.data.publishedAt}
          </time>
        </div>
        <span>‚Ä¢</span>
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span class="text-sm uppercase">{article.data.author}</span>
        </div>
      </div>

      <!-- Tags -->
      {article.data.tags && article.data.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-6">
          {article.data.tags.map((tag) => (
            <a
              href={import.meta.env.BASE_URL + `/hledej/?tag=${encodeURIComponent(tag)}`}
              class="px-3 py-1 text-sm bg-bg-page text-text-secondary hover:bg-accent-rose hover:text-white transition-colors border border-border-light"
            >
              {tag}
            </a>
          ))}
        </div>
      )}
    </header>

    <!-- Featured Image -->
    {article.data.image && (
      <figure class="mb-8 -mx-4 md:mx-0">
        <img
          src={import.meta.env.BASE_URL + article.data.image}
          alt={article.data.title}
          class="w-full h-auto object-cover max-h-[500px]"
        />
      </figure>
    )}

    <!-- Article Content -->
    <div class="prose prose-lg max-w-none mb-12">
      <!-- Excerpt -->
      <p class="text-xl text-text-secondary leading-relaxed mb-6 font-light">
        {article.data.excerpt}
      </p>

      <!-- Main Content -->
      <div class="text-text-primary leading-relaxed space-y-4">
        <Content />
      </div>
    </div>

    <!-- Share & Actions -->
    <div class="border-t border-b border-border-light py-6 mb-12">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-2">
          <span class="text-sm text-text-muted uppercase">Sd√≠let:</span>
          <div class="flex gap-2">
            <a
              href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(`https://dgkralupy.cz/aktualne/${article.slug}`)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="p-2 bg-bg-content border border-border-light hover:bg-accent-rose hover:text-white hover:border-accent-rose transition-colors"
              aria-label="Sd√≠let na Facebooku"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
            </a>
            <button
              onclick="navigator.clipboard.writeText(window.location.href)"
              class="p-2 bg-bg-content border border-border-light hover:bg-accent-rose hover:text-white hover:border-accent-rose transition-colors"
              aria-label="Kop√≠rovat odkaz"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
              </svg>
            </button>
          </div>
        </div>
        <a
          href={import.meta.env.BASE_URL + "/aktualne"}
          class="inline-flex items-center gap-2 text-sm text-accent-rose hover:underline font-normal uppercase"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Zpƒõt na aktuality
        </a>
      </div>
    </div>

    <!-- Related Articles -->
    {relatedArticles.length > 0 && (
      <section class="mt-12">
        <h2 class="text-2xl font-heading font-thin uppercase text-text-primary border-b-2 border-secondary pb-4 mb-6">
          Souvisej√≠c√≠ ƒçl√°nky
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {relatedArticles.map((relatedArticle) => (
            <article class="bg-bg-content border border-border-light overflow-hidden hover:shadow-lg transition-shadow">
              <a href={import.meta.env.BASE_URL + `/aktualne/${relatedArticle.slug}`} class="block">
                {relatedArticle.data.image ? (
                  <img
                    src={import.meta.env.BASE_URL + relatedArticle.data.image}
                    alt={relatedArticle.data.title}
                    class="w-full h-48 object-cover"
                    loading="lazy"
                  />
                ) : (
                  <div class="w-full h-48 flex items-center justify-center bg-primary/10">
                    <span class="text-primary text-4xl">üì∞</span>
                  </div>
                )}
                <div class="p-4">
                  <h3 class="text-lg font-heading font-thin uppercase text-text-primary hover:text-accent-rose transition-colors mb-2">
                    {relatedArticle.data.title}
                  </h3>
                  <p class="text-sm text-text-muted uppercase">{relatedArticle.data.publishedAt}</p>
                </div>
              </a>
            </article>
          ))}
        </div>
      </section>
    )}
  </article>
</BaseLayout>
