---
/**
 * ResponsiveImage Component (Cloudinary-only)
 *
 * Displays images from Cloudinary CDN with automatic optimizations.
 * All images use Cloudinary transformations (format, quality, resize, focus point).
 *
 * @component
 * @example
 * <ResponsiveImage
 *   image={{ src: "dgkralupy/article.jpg", alt: "Description", focusPoint: { x: 60, y: 40 } }}
 *   variant="card"
 *   loading="lazy"
 * />
 */

import { normalizeImageData } from '../lib/utils/imageProcessing';
import { getCloudinaryUrl, extractPublicId } from '../lib/utils/cloudinary';
import type { ImageData } from '../types/image';
import type { ImageVariant } from '../lib/utils/imageVariants';

interface Props {
  /** Image data (supports both string path and object format) */
  image: ImageData;
  /** Variant to use (hero, card, thumbnail, detail) */
  variant: ImageVariant;
  /** Loading strategy (lazy or eager) */
  loading?: 'lazy' | 'eager';
  /** Additional CSS classes */
  class?: string;
  /** Additional inline styles */
  style?: string;
  /** Alt text override (fallback if not in image data) */
  alt?: string;
}

const {
  image,
  variant,
  loading = 'lazy',
  class: className = '',
  style = '',
  alt: altOverride
} = Astro.props;

// Normalize image data (handles both string and object formats)
const imageData = normalizeImageData(image);

// Use alt from props, then from image data, then empty string
const altText = altOverride || imageData.alt || '';

// âœ… CLOUDINARY-ONLY: All images are from Cloudinary
// Extract public_id (handles both full URLs and public_ids)
const publicId = extractPublicId(imageData.src);

// Generate optimized Cloudinary URL with transformations
const imageSrc = getCloudinaryUrl(publicId, variant, imageData.focusPoint);

/**
 * Implementation notes:
 * - All images use Cloudinary with transformations
 * - Automatic format optimization (AVIF, WebP, JPG based on browser)
 * - Focus point applied via Cloudinary URL transformations
 * - No local image fallback needed
 */
---

<img
  src={imageSrc}
  alt={altText}
  loading={loading}
  decoding="async"
  class={className}
  style={style}
  data-variant={variant}
  data-cloudinary="true"
  data-focus-point={imageData.focusPoint ? `${imageData.focusPoint.x},${imageData.focusPoint.y}` : undefined}
/>
